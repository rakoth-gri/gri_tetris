import{randomIndex,showMess,cellsAction,getCurrCoords,isGameOver,isBottomRow,showScore,debounce,changeLevel}from"./services.min.js";import{FIGURES,ROW,KEY_LIST,$FIELD,$START,$SCORE,$NOTE,$COLOR,$RESET,SPEED_LIST,$CONTROLS}from"./consts.min.js";let intervalId_g,$CELLS_g,currFieldPos_g=4,figRot_g=0,fig_g=FIGURES[randomIndex(FIGURES)],score_g=0,level_g=0,speed_g=SPEED_LIST[level_g].value,gameOver_g=!0,figCol_g="var(--app-danger-color)";function clearField(e){gameOver_g=!0,cellsAction($CELLS_g.slice(0,200),(e=>e.classList.remove("bottom"))),$CELLS_g.forEach(((e,r)=>{setTimeout((()=>e.removeAttribute("style")),10*r)})),showMess(e,$NOTE)}$FIELD.insertAdjacentHTML("beforeend",new Array(210).fill("").map(((e,r)=>`\n            <div class="${r>199?"field__cell bottom transparent":"field__cell"}"></div>   \n        `)).join("")),$CELLS_g=[...$FIELD.querySelectorAll(".field__cell")],$CONTROLS.insertAdjacentHTML("beforeend",`<select class="controls__speed" id="$LEVEL_PANEL">\n  ${SPEED_LIST.map((({text:e,value:r})=>`<option value="${r}" disabled> ${e} </option>`)).join("")}\n</select>`),showScore($SCORE,score_g),$COLOR.setAttribute("value","#a41f1f");const debouncedColor=debounce((e=>figCol_g=e),500),draw=e=>e.forEach((e=>$CELLS_g[e].style.backgroundColor=figCol_g)),unDraw=e=>e.forEach((e=>$CELLS_g[e].removeAttribute("style")));function updateGlobalVars(){clearInterval(intervalId_g),intervalId_g=null,currFieldPos_g=4,fig_g=FIGURES[randomIndex(FIGURES)],figRot_g=0}function zeroedLevel(){speed_g=SPEED_LIST[level_g].value,$LEVEL_PANEL.value=speed_g}function prepareForNextFigure(){updateGlobalVars(),changeScore(),level_g=changeLevel(score_g),level_g!==SPEED_LIST.length?(zeroedLevel(),start(speed_g)):reset("CONGRATULATION, YOU ARE WINNER...")}function reset(e){updateGlobalVars(),level_g=0,score_g=0,zeroedLevel(),showScore($SCORE,score_g),clearField(e)}function changeScore(){let e=0;for(let r=0;r<199;r+=ROW){const o=[r,r+1,r+2,r+3,r+4,r+5,r+6,r+7,r+8,r+9].map((e=>$CELLS_g[e]));if(o.every((e=>e.className.includes("bottom")))){score_g+=10,showScore($SCORE,score_g),o.forEach((e=>{e.classList.remove("bottom"),e.removeAttribute("style")}));let t=$CELLS_g.splice(r,ROW);$CELLS_g=t.concat($CELLS_g),e++}}e&&($FIELD.innerHTML="",$FIELD.append(...$CELLS_g),$CELLS_g=[...$FIELD.querySelectorAll(".field__cell")])}function start(e){draw(getCurrCoords(fig_g,figRot_g,currFieldPos_g)),isGameOver(getCurrCoords(fig_g,figRot_g,currFieldPos_g),$CELLS_g,ROW,reset)?reset("SORRY, YOU'VE LOST..."):intervalId_g=setInterval((()=>{unDraw(getCurrCoords(fig_g,figRot_g,currFieldPos_g)),currFieldPos_g+=ROW;let e=getCurrCoords(fig_g,figRot_g,currFieldPos_g);draw(e),isBottomRow(e,$CELLS_g,ROW,prepareForNextFigure)}),e)}function keyboardController(e){if(e.preventDefault(),KEY_LIST.indexOf(e.key)<0)return;if(gameOver_g)return;let r=getCurrCoords(fig_g,figRot_g,currFieldPos_g);if(!(r.some((e=>e%10==0))&&"ArrowLeft"===e.key||r.some((e=>(e+1)%10==0))&&"ArrowRight"===e.key)){switch(unDraw(r),e.key){case"ArrowUp":figRot_g++;break;case"ArrowDown":currFieldPos_g+=ROW;break;case"ArrowRight":currFieldPos_g++;break;default:currFieldPos_g--}figRot_g>=fig_g.length&&(figRot_g=0),figRot_g<0&&(figRot_g=fig_g.length-1),r=getCurrCoords(fig_g,figRot_g,currFieldPos_g),draw(r),isBottomRow(r,$CELLS_g,ROW,prepareForNextFigure)}}$START.addEventListener("click",(function(){intervalId_g?(clearInterval(intervalId_g),intervalId_g=null):(gameOver_g=!1,start(speed_g),showMess("GAME STARTED!",$NOTE))})),$RESET.addEventListener("click",(()=>reset("PRESS START TO BEGIN..."))),$COLOR.addEventListener("input",(function(e){debouncedColor(this.value)})),document.body.addEventListener("keydown",keyboardController);